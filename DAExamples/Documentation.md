# APSIM-EnKF Documentation

## Build
Platform: Windows 10  
Compiler: Visual Studio 2022  
Please see APSIMX instruction for developers from https://apsimnextgeneration.netlify.app/contribute/compile/.  

 
Step 1: Build APSIM.sln under APSIM-EnKF\APSIM.DA  
[ToDo] ~~Step 2: Build CreateFiles.sln under APSIM-EnKF\CreateFiles~~  

## Introduction to APSIM.sln
This reporosity was forked from APSIM Initiatives on: https://github.com/APSIMInitiative/ApsimX.git.  

Major update from the original APSIMX version:
1. DataAssimilation module was added to ApsimX.DA\Models\DataAssimilation.  
2. The Clock.cs file (ApsimX.DA\Models\Clock.cs) was significantly modified.  
3. New links in Wheat and Soil modules were added to exchange data between modules.


## Introduction to input files
The input folder structure and basic elements. You can rename the DAExample folder (eg, WheatDA) .
### Basic elements
Basic elements cannot be renamed unless you modify the source code accordingly.

DAExample\
---- Met\  
-------- Perturbed met files. All met files under this directory were generated by perturbing Origin\Weather.met  
---- Obs\  
-------- Observations to be assimilated. Observation files under this Obs directory will be assimilated. Observation files must be named as "[StateName]_Obs.csv".  
-------- The number of observation data must be no less than the days of simulation. Negative value means data. Examples of observation files are under Obs\General\*.  
---- Output\
-------- OpenLoop.apsimx  
-------- EnKF.apsimx 

[ToDo] ~~### Other elements 
DAExample\  
---- Origin\  
-------- OpenLoop.apsimx  
-------- Weather.met  
-------- Perturb_Control.xml  
---- Batch\
-------- Batch examples of how to perturb weather, cultivar and initial conditions.~~  

----
## How to run the model
1. Compile APSIM.DA and CreateFiles projects.  
2. Prepare APSIMX input file and weather file, make sure they run successfully without data assimilation.  
3. Set EnKF parameters: uncertainty for weather, cultivar and initial conditions.  
4. Double-click script (ToDo) to generate ensemble.  
5. Run APSIM-EnKF model from script (ToDo).  
6. Double-click script (ToDo) to plot figures and check result.  


## Introduction to output files
|Scenario				|Input file		| APSIM Output	| Data Assimilation Output	| Description	|
|----					|----			|----			|----						|----			|
| OpenLoop				|OpenLoop.apsimx|OpenLoop.db	|OpenLoop.sqlite			|			|
| EnKF Data Assimilation|EnKF.apsimx	|EnKF.db		|EnKF.sqlite				|			|


How to view my output:  
Open with any Database Browser (eg, DB Browser for SQLite).  

## Example
[TODO]


## Citation and acknowledgement
To use the EnKF framework, please cite one of the following:  
	Zhang, Y., Walker, J. P., Pauwels, V. R. N. & Sadeh, Y. 2022. Assimilation of Wheat and Soil States into the APSIM-Wheat Crop Model: A Case Study. Remote Sensing, 14, 65.  

To use the APSIM model, please check the latest citation and acknowledgement requirements from the APSIM Homepage.
